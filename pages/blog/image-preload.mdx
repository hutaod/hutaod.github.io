# å›¾ç‰‡é¢„åŠ è½½

## èƒŒæ™¯

å¤§å®¶æœ‰æ²¡æœ‰é‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼Œæœ‰ä¸€ä¸ªé¡µé¢å…¨éƒ¨éƒ½æ˜¯æœ‰å›¾ç‰‡ç»„æˆï¼Œä½†æœ‰éƒ¨åˆ†å›¾ç‰‡å¾ˆå…³é”®ï¼Œå¦‚æœæ²¡æœ‰ä¸‹è½½å®Œæˆæˆ–è€…ä¸‹è½½å¤±è´¥ï¼Œè¿™æ—¶å€™ä¸åº”è¯¥æ˜¾ç¤ºé¡µé¢å†…å®¹ï¼Œç»§ç»­æ˜¾ç¤ºåŠ è½½ç»„ä»¶ï¼ˆæ¯”å¦‚èš‚èšåº„å›­ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªåŠ è½½ä¸­çš„è¦†ç›–å±‚ï¼‰ï¼Œå¦åˆ™ä¼šå¸¦ç»™ç”¨æˆ·ä¸å¥½çš„ä½“éªŒã€‚è¿™æ—¶å€™å°±éœ€è¦å¯¹å…³é”®å›¾ç‰‡è¿›è¡Œé¢„åŠ è½½ï¼Œç­‰å›¾ç‰‡ä¸‹è½½å®Œæˆåï¼Œå†å…³é—­åŠ è½½ç»„ä»¶ï¼Œå†å¯¹å›¾ç‰‡è¿›è¡Œæ¸²æŸ“ã€‚

## å®ç°

é’ˆå¯¹å›¾ç‰‡é¢„åŠ è½½è¿™ä¸ªéœ€æ±‚ï¼Œå¯ä»¥å°è£…ä¸€ä¸ªå›¾ç‰‡é¢„åŠ è½½æ–¹æ³•ï¼š

```javascript
/**
 * å›¾ç‰‡é¢„åŠ è½½ï¼ŒåŠ è½½æˆåŠŸè¿”å›å›¾ç‰‡é“¾æ¥ï¼Œå¤±è´¥è¿”å› undefined
 * @param url å›¾ç‰‡é“¾æ¥
 */
export function prefetch(url: string): Promise<string | undefined> {
  return new Promise((resolve) => {
    // åŠ è½½å›¾ç‰‡
    const virtualImage = new Image();
    virtualImage.src = url;
    // å›¾ç‰‡è¢«åŠ è½½å®Œæˆè¿‡ï¼Œè¿™æ—¶å€™completeä¼šä¸ºtrue
    if (virtualImage.complete) {
      return resolve(url);
    }
    // åŠ è½½å®Œæˆ
    virtualImage.onload = (): void => {
      resolve(url);
    };
    // åŠ è½½å¤±è´¥
    virtualImage.onerror = (): void => {
      resolve();
    };
  });
}
```

å¦‚æœæƒ³åŒæ—¶é¢„åŠ è½½å¤šä¸ªå›¾ç‰‡ï¼Œä¸”æˆåŠŸè¿”å› `true` ï¼Œå¤±è´¥è¿”å› `false` ï¼š

```javascript
/**
 * æˆåŠŸï¼Œè¿”å›trueï¼Œå¤±è´¥è¿”å› false
 * @param urls å›¾ç‰‡é“¾æ¥æ•°ç»„
 */
export async function prefetchAll(urls: string[]): Promise<boolean> {
  for (let index = 0; index < urls.length; index++) {
    // æœ‰ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™è¿”å›false
    if (!(await prefetch(urls[index]))) {
      return false;
    }
  }
  // å…¨éƒ¨æˆåŠŸï¼Œè¿”å›true
  return true;
}
```

ä¸Šé¢è¿™ç§å®ç°æ–¹å¼ä¼šä¸²è¡Œå»è¯·æ±‚å›¾ç‰‡èµ„æºï¼Œå¦‚æœå›¾ç‰‡éƒ½èƒ½è¯·æ±‚æˆåŠŸï¼Œæ•ˆç‡ä½ä¸€äº›ï¼Œä¸èƒ½å……åˆ†åˆ©ç”¨ç½‘ç»œï¼Œä¸è¿‡å¦‚æœä¸æ˜¯æœ€åä¸€å¼ å›¾ç‰‡è¯·æ±‚å¤±è´¥ï¼Œå¯ä»¥èŠ‚çº¦æµé‡ğŸ¤¦â€â™‚ï¸ã€‚

ä¸‹é¢ç”¨ç±»ä¼¼ `promise all` çš„æ–¹å¼ï¼Œå…ˆæ‰¹é‡å‘è¯·æ±‚ï¼Œæœ‰ä¸€ä¸ªå¤±è´¥åˆ™ç›´æ¥ `resolve(false)`
```javascript
/**
 * æˆåŠŸï¼Œè¿”å›trueï¼Œå¤±è´¥è¿”å› false
 * @param urls å›¾ç‰‡é“¾æ¥æ•°ç»„
 */
export function prefetchAll2(urls: string[]): Promise<boolean> {
  return new Promise((resolve) => {
    const length = urls.length;
    const results = [];
    const thenFn = (url?: string): void => {
      // æœ‰ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™è¿”å›false
      if (!url) {
        resolve(false);
      }
      // æˆåŠŸåˆ™åŠ å…¥results
      results.push(url);

      // å…¨éƒ¨åŠ è½½æˆåŠŸ
      if (results.length === length) {
        resolve(true);
      }
    };
    // å…ˆè§¦å‘è¯·æ±‚
    for (let index = 0; index < length; index++) {
      prefetch(urls[index]).then(thenFn);
    }
  });
}
```

ä¸Šé¢ä½¿ç”¨Promise çš„ thenæ¥è§¦å‘å›è°ƒï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå¤±è´¥çš„æ—¶å€™ï¼Œä¸ç”¨ç­‰å¾…å…¶ä»–å›¾ç‰‡åŠ è½½ç»“æŸ


å¦‚æœæƒ³åŒæ—¶é¢„åŠ è½½å¤šä¸ªå›¾ç‰‡ï¼Œä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè¿”å›å›¾ç‰‡é“¾æ¥æ•°ç»„ï¼ˆåŠ è½½æˆåŠŸçš„è¿”å›é“¾æ¥ï¼Œå¤±è´¥çš„è¿”å›undefinedï¼Œä»¥ä¾¿äºåŒºåˆ†å“ªä¸€å¼ å¤±è´¥æˆ–è€…è¿‡æ»¤æ‰å¤±è´¥çš„å›¾ç‰‡ï¼‰ï¼š

```javascript
/**
 * å…¨éƒ¨åŠ è½½å®Œï¼Œä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œè¿”å›å›¾ç‰‡é“¾æ¥æ•°ç»„ï¼ˆåŠ è½½æˆåŠŸçš„è¿”å›é“¾æ¥ï¼Œå¤±è´¥çš„è¿”å›undefinedï¼‰
 * @param urls å›¾ç‰‡é“¾æ¥æ•°ç»„
 */
export async function prefetchAllSettled(urls: string[]): Promise<(undefined | string)[]> {
  const result: (undefined | string)[] = [];
  for (let index = 0; index < urls.length; index++) {
    result.push(await prefetch(urls[index]));
  }
  return result;
}
```

ä¸Šé¢è¿™ç§å®ç°æ–¹å¼ä¹Ÿä¼šä¸²è¡Œå»è¯·æ±‚å›¾ç‰‡èµ„æºï¼Œä¸èƒ½å……åˆ†åˆ©ç”¨ç½‘ç»œã€‚

ä¸‹é¢ç”¨ç±»ä¼¼ `promise allSettled` çš„æ–¹å¼ï¼Œå…ˆæ‰¹é‡å‘è¯·æ±‚ï¼Œå†ç­‰å¾…æ‰€æœ‰è¯·æ±‚ç»“æœ

```javascript
/**
 * å…¨éƒ¨åŠ è½½å®Œï¼Œä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œè¿”å›å›¾ç‰‡é“¾æ¥æ•°ç»„ï¼ˆåŠ è½½æˆåŠŸçš„è¿”å›é“¾æ¥ï¼Œå¤±è´¥çš„è¿”å›undefinedï¼‰
 * @param urls å›¾ç‰‡é“¾æ¥æ•°ç»„
 */
export async function prefetchAllSettled2(urls: string[]): Promise<(undefined | string)[]> {
  const length = urls.length;
  const result: (undefined | string)[] = [];
  const promises = [];
  // å…ˆè§¦å‘è¯·æ±‚
  for (let index = 0; index < length; index++) {
    promises.push(prefetch(urls[index]));
  }
  // ç­‰å¾…æ‰€æœ‰ç»“æœ
  for (let index = 0; index < length; index++) {
    result.push(await promises[index]);
  }
  return result;
}
```

`prefetchAll2` å’Œ `prefetchAllSettled2` ä¸¤ä¸ªæ–¹æ³•æ¨¡æ‹Ÿäº† `promise` çš„ `all` å’Œ `allSettled` çš„ç®€å•å®ç°